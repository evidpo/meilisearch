# Changelog 2026-01-08_14-30

## Автоопределение контекста в виджете рекомендаций

### Что сделано

Виджет рекомендаций теперь автоматически определяет тип страницы по URL и подбирает релевантные курсы без необходимости вручную указывать data-атрибуты.

---

### Изменения

**Автоопределение по URL:**
- `/k/637` — страница курса: ищет курс по коду, показывает похожие по направлению
- `/k/all` — каталог: показывает популярные курсы
- `/Охрана труда` — страница направления: курсы этого направления
- `/` — главная: популярные курсы
- `/cart`, `/checkout` и др. — системные страницы: общие рекомендации

**Новые функции:**
- `detectPageContext()` — определяет тип страницы по URL
- `getCoursepageContext(code)` — ищет курс по коду, возвращает direction
- `checkDirectionExists(name)` — проверяет существование направления

**Обратная совместимость:**
- Если указаны `data-direction` или `data-exclude-id` — используются они
- Автоопределение работает только когда атрибуты не заданы

**Динамические заголовки:**
- Страница курса: "Похожие курсы"
- Каталог/главная: "Популярные курсы"
- Страница направления: "Курсы по направлению"
- Системные страницы: "Рекомендуем вам"
- Можно переопределить через `data-title`

---

### Затронутые файлы

- `src/evidpo-recommendations.html` — добавлена логика автоопределения контекста

---

### Требуется настройка Meilisearch

Для работы на страницах курсов нужно добавить `code` в filterableAttributes:

```bash
curl -X PATCH 'https://getmeilimeilisearchv190-production-6123b.up.railway.app/indexes/courses/settings' \
  -H 'Authorization: Bearer 16mx5lg484k1bwyfamrxp6gql25stxu8' \
  -H 'Content-Type: application/json' \
  -d '{"filterableAttributes": ["direction", "code"]}'
```

---

### Примечания

- Системные пути (`/cart`, `/checkout`, `/login` и др.) определяются через массив `SYSTEM_PATHS`
- Страницы направлений проверяются через запрос к Meilisearch
- При ошибках загрузки курса показываются популярные курсы (fallback)

---

**Автор:** Claude
**Дата:** 2026-01-08
