# Changelog 2026-01-12_17-30

## Оптимизация производительности виджета рекомендаций

### Что сделано

Реализована комплексная оптимизация виджета рекомендаций для ускорения загрузки страницы. Виджет больше не блокирует рендер страницы и загружает данные только когда нужно.

---

### Изменения

**Ленивая загрузка (Intersection Observer):**
- Виджет теперь инициализируется только когда появляется во viewport
- rootMargin: 200px — начинает загрузку за 200px до появления
- Fallback на немедленную загрузку для старых браузеров

**Отложенная инициализация (requestIdleCallback):**
- JS выполняется в idle время браузера
- Fallback на setTimeout(50ms) для Safari
- Не блокирует критические ресурсы страницы

**Кэширование в localStorage:**
- TTL: 5 минут для рекомендаций
- Ключ кэша включает направление: `evidpo_rec_dir_{направление}_ex_{excludeId}`
- Разные ключи для разных контекстов (направление, главная, каталог)
- Мгновенная загрузка при повторных визитах

**Параллельные запросы (Promise.all):**
- Запросы по направлению и популярные курсы идут одновременно
- Сокращает время ожидания вдвое когда нужны оба типа данных
- Умное объединение результатов с исключением дубликатов

---

### Затронутые файлы

- `src/evidpo-recommendations.html` — основные оптимизации

---

### Технические детали

**До оптимизации:**
```
Загрузка страницы → JS выполняется сразу → 2-4 последовательных запроса к Meilisearch
```

**После оптимизации:**
```
Загрузка страницы → Intersection Observer ждёт → requestIdleCallback →
Проверка кэша → (если нет) 2 параллельных запроса → Сохранение в кэш
```

**Поддержка браузеров:**
- Intersection Observer: 95%+ (fallback для IE)
- requestIdleCallback: 75% (fallback для Safari)
- localStorage: 99%+
- Promise.all: 97%+

---

### Примечания

- Кэш автоматически очищается по истечении TTL
- При ошибке localStorage виджет работает без кэша
- Оптимизации совместимы с Creatium (vanilla JS, без npm)

---

**Автор:** Claude
**Дата:** 2026-01-12
