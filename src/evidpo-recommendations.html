<!-- Виджет рекомендаций курсов для evidpo.ru -->
<!-- Параметры: data-direction, data-exclude-id, data-count -->
<style>
/* ========== КОНТЕЙНЕР ========== */
.evidpo-rec {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  padding: 24px;
  background: #f8fafc;
  border-radius: 16px;
}

/* Заголовок */
.evidpo-rec-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.evidpo-rec-title {
  font-size: 20px;
  font-weight: 600;
  color: #1e293b;
  margin: 0;
}

/* Кнопки навигации */
.evidpo-rec-nav {
  display: flex;
  gap: 8px;
}

.evidpo-rec-btn {
  width: 40px;
  height: 40px;
  border: 1px solid #e2e8f0;
  border-radius: 50%;
  background: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.evidpo-rec-btn:hover:not(:disabled) {
  border-color: #7c3aed;
  background: #f5f3ff;
}

.evidpo-rec-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.evidpo-rec-btn svg {
  width: 20px;
  height: 20px;
  stroke: #64748b;
  fill: none;
}

.evidpo-rec-btn:hover:not(:disabled) svg {
  stroke: #7c3aed;
}

/* ========== КАРУСЕЛЬ ========== */
.evidpo-rec-carousel {
  position: relative;
  overflow: hidden;
}

.evidpo-rec-track {
  display: flex;
  gap: 20px;
  transition: transform 0.3s ease;
}

/* ========== КАРТОЧКА ========== */
.evidpo-rec-card {
  flex: 0 0 calc(25% - 15px);
  min-width: 200px;
  max-width: 280px;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  overflow: hidden;
  text-decoration: none;
  transition: all 0.2s;
  display: block;
}

.evidpo-rec-card:hover {
  border-color: #7c3aed;
  box-shadow: 0 8px 30px rgba(124, 58, 237, 0.12);
  transform: translateY(-2px);
}

/* Изображение */
.evidpo-rec-image {
  width: 100%;
  height: 140px;
  background: #f1f5f9;
  overflow: hidden;
}

.evidpo-rec-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.evidpo-rec-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
}

.evidpo-rec-placeholder svg {
  width: 40px;
  height: 40px;
  stroke: #94a3b8;
}

/* Информация */
.evidpo-rec-info {
  padding: 16px;
}

.evidpo-rec-card-title {
  font-size: 14px;
  font-weight: 500;
  color: #1e293b;
  line-height: 1.4;
  margin-bottom: 12px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  min-height: 40px;
}

.evidpo-rec-price {
  font-size: 16px;
  font-weight: 600;
  color: #7c3aed;
  margin-bottom: 12px;
}

.evidpo-rec-link {
  display: inline-block;
  padding: 8px 16px;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  color: #64748b;
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s;
}

.evidpo-rec-card:hover .evidpo-rec-link {
  border-color: #7c3aed;
  color: #7c3aed;
}

/* ========== ТОЧКИ НАВИГАЦИИ ========== */
.evidpo-rec-dots {
  display: none;
  justify-content: center;
  gap: 8px;
  margin-top: 16px;
}

.evidpo-rec-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #e2e8f0;
  border: none;
  padding: 0;
  cursor: pointer;
  transition: all 0.2s;
}

.evidpo-rec-dot.active {
  background: #7c3aed;
  width: 24px;
  border-radius: 4px;
}

/* ========== ЗАГРУЗКА ========== */
.evidpo-rec-loading {
  display: flex;
  gap: 20px;
}

.evidpo-rec-skeleton {
  flex: 0 0 calc(25% - 15px);
  min-width: 200px;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
}

.evidpo-rec-skeleton-img {
  height: 140px;
  background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

.evidpo-rec-skeleton-info {
  padding: 16px;
}

.evidpo-rec-skeleton-title {
  height: 40px;
  background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
  margin-bottom: 12px;
}

.evidpo-rec-skeleton-price {
  height: 20px;
  width: 60%;
  background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
}

@keyframes shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ========== ПУСТОЙ РЕЗУЛЬТАТ ========== */
.evidpo-rec-empty {
  text-align: center;
  padding: 40px 20px;
  color: #64748b;
}

/* ========== АДАПТИВНОСТЬ ========== */
@media (max-width: 1024px) {
  .evidpo-rec-card,
  .evidpo-rec-skeleton {
    flex: 0 0 calc(33.333% - 14px);
  }
}

@media (max-width: 768px) {
  .evidpo-rec {
    padding: 20px 16px;
  }

  .evidpo-rec-title {
    font-size: 18px;
  }

  .evidpo-rec-nav {
    display: none;
  }

  .evidpo-rec-carousel {
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .evidpo-rec-carousel::-webkit-scrollbar {
    display: none;
  }

  .evidpo-rec-track {
    transition: none;
  }

  .evidpo-rec-card,
  .evidpo-rec-skeleton {
    flex: 0 0 calc(50% - 10px);
    min-width: 150px;
    scroll-snap-align: start;
  }

  .evidpo-rec-image {
    height: 120px;
  }

  .evidpo-rec-info {
    padding: 12px;
  }

  .evidpo-rec-card-title {
    font-size: 13px;
    min-height: 36px;
  }

  .evidpo-rec-dots {
    display: flex;
  }
}

@media (max-width: 480px) {
  .evidpo-rec {
    padding: 16px 12px;
  }

  .evidpo-rec-title {
    font-size: 16px;
  }

  .evidpo-rec-track {
    gap: 12px;
  }

  .evidpo-rec-card,
  .evidpo-rec-skeleton {
    flex: 0 0 calc(50% - 6px);
  }

  .evidpo-rec-image {
    height: 100px;
  }

  .evidpo-rec-card-title {
    font-size: 12px;
  }

  .evidpo-rec-price {
    font-size: 14px;
  }

  .evidpo-rec-link {
    padding: 6px 12px;
    font-size: 12px;
  }
}
</style>

<div id="evidpo-recommendations"></div>

<script>
(function() {
  // Конфигурация Meilisearch
  const MEILI_HOST = 'https://getmeilimeilisearchv190-production-6123b.up.railway.app';
  const MEILI_KEY = 'b17c51453595ca37ff81b5c5b7ae8b7d0541d6b3e375fecd86831572dee58660';
  const INDEX = 'courses';

  // Получаем контейнер и параметры
  const container = document.getElementById('evidpo-recommendations');
  if (!container) return;

  const direction = container.getAttribute('data-direction') || '';
  const excludeId = container.getAttribute('data-exclude-id') || '';
  const count = parseInt(container.getAttribute('data-count')) || 4;
  const title = container.getAttribute('data-title') || 'Специально для вас';

  // Состояние карусели
  let courses = [];
  let currentPage = 0;
  let cardsPerPage = 4;

  // Запуск
  init();

  async function init() {
    updateCardsPerPage();
    showLoading();

    try {
      courses = await fetchRecommendations();
      if (courses.length > 0) {
        render();
        setupNavigation();
      } else {
        showEmpty();
      }
    } catch (error) {
      console.error('Ошибка загрузки рекомендаций:', error);
      showEmpty();
    }

    // Обновление при ресайзе
    window.addEventListener('resize', debounce(handleResize, 200));
  }

  // Загрузка рекомендаций из Meilisearch
  async function fetchRecommendations() {
    let results = [];

    // Если указано направление — ищем по нему
    if (direction) {
      results = await searchCourses({
        filter: excludeId
          ? `direction = "${direction}" AND id != "${excludeId}"`
          : `direction = "${direction}"`,
        sort: ['students:desc'],
        limit: count + 2 // запас на случай fallback
      });
    }

    // Fallback: если мало результатов — добираем популярные
    if (results.length < count) {
      const excludeIds = results.map(c => c.id);
      if (excludeId) excludeIds.push(excludeId);

      const popular = await searchCourses({
        filter: excludeIds.length > 0
          ? excludeIds.map(id => `id != "${id}"`).join(' AND ')
          : null,
        sort: ['students:desc'],
        limit: count - results.length
      });

      results = [...results, ...popular];
    }

    return results.slice(0, count);
  }

  // Запрос к Meilisearch
  async function searchCourses(options) {
    const body = {
      q: '',
      limit: options.limit || count,
      sort: options.sort || ['students:desc']
    };

    if (options.filter) {
      body.filter = options.filter;
    }

    const response = await fetch(`${MEILI_HOST}/indexes/${INDEX}/search`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${MEILI_KEY}`
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      throw new Error(`Meilisearch error: ${response.status}`);
    }

    const data = await response.json();
    return data.hits || [];
  }

  // Показать загрузку
  function showLoading() {
    const skeletons = Array(cardsPerPage).fill(0).map(() => `
      <div class="evidpo-rec-skeleton">
        <div class="evidpo-rec-skeleton-img"></div>
        <div class="evidpo-rec-skeleton-info">
          <div class="evidpo-rec-skeleton-title"></div>
          <div class="evidpo-rec-skeleton-price"></div>
        </div>
      </div>
    `).join('');

    container.innerHTML = `
      <div class="evidpo-rec">
        <div class="evidpo-rec-header">
          <h3 class="evidpo-rec-title">${title}</h3>
        </div>
        <div class="evidpo-rec-loading">${skeletons}</div>
      </div>
    `;
  }

  // Показать пустое состояние
  function showEmpty() {
    container.innerHTML = `
      <div class="evidpo-rec">
        <div class="evidpo-rec-empty">Рекомендации не найдены</div>
      </div>
    `;
  }

  // Рендер карусели
  function render() {
    const totalPages = Math.ceil(courses.length / cardsPerPage);
    const cardsHtml = courses.map(renderCard).join('');
    const dotsHtml = totalPages > 1
      ? Array(totalPages).fill(0).map((_, i) =>
          `<button class="evidpo-rec-dot${i === 0 ? ' active' : ''}" data-page="${i}"></button>`
        ).join('')
      : '';

    container.innerHTML = `
      <div class="evidpo-rec">
        <div class="evidpo-rec-header">
          <h3 class="evidpo-rec-title">${title}</h3>
          <div class="evidpo-rec-nav">
            <button class="evidpo-rec-btn evidpo-rec-prev" aria-label="Назад" disabled>
              <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m15 18-6-6 6-6"/>
              </svg>
            </button>
            <button class="evidpo-rec-btn evidpo-rec-next" aria-label="Вперёд">
              <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m9 18 6-6-6-6"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="evidpo-rec-carousel">
          <div class="evidpo-rec-track">${cardsHtml}</div>
        </div>
        <div class="evidpo-rec-dots">${dotsHtml}</div>
      </div>
    `;

    updateNavButtons();
  }

  // Рендер карточки
  function renderCard(course) {
    const price = course.price ? `${course.price.toLocaleString('ru-RU')} ₽` : '';
    const imageUrl = course.image || '';

    const placeholder = `
      <div class="evidpo-rec-placeholder">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
        </svg>
      </div>
    `;

    return `
      <a href="${course.url}" target="_blank" rel="noopener" class="evidpo-rec-card">
        <div class="evidpo-rec-image">
          ${imageUrl
            ? `<img src="${imageUrl}" alt="" loading="lazy" onerror="this.parentElement.innerHTML='${placeholder.replace(/'/g, "\\'").replace(/\n/g, '').replace(/\s+/g, ' ')}'">`
            : placeholder
          }
        </div>
        <div class="evidpo-rec-info">
          <div class="evidpo-rec-card-title">${course.title}</div>
          ${price ? `<div class="evidpo-rec-price">${price}</div>` : ''}
          <span class="evidpo-rec-link">Подробнее</span>
        </div>
      </a>
    `;
  }

  // Настройка навигации
  function setupNavigation() {
    const prevBtn = container.querySelector('.evidpo-rec-prev');
    const nextBtn = container.querySelector('.evidpo-rec-next');
    const dots = container.querySelectorAll('.evidpo-rec-dot');
    const track = container.querySelector('.evidpo-rec-track');

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          updateCarousel();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(courses.length / cardsPerPage);
        if (currentPage < totalPages - 1) {
          currentPage++;
          updateCarousel();
        }
      });
    }

    dots.forEach(dot => {
      dot.addEventListener('click', () => {
        currentPage = parseInt(dot.getAttribute('data-page'));
        updateCarousel();
      });
    });

    // Скрыть навигацию если карточек мало
    if (courses.length <= cardsPerPage) {
      if (prevBtn) prevBtn.style.display = 'none';
      if (nextBtn) nextBtn.style.display = 'none';
    }
  }

  // Обновить карусель
  function updateCarousel() {
    const track = container.querySelector('.evidpo-rec-track');
    const card = container.querySelector('.evidpo-rec-card');

    if (track && card) {
      const cardWidth = card.offsetWidth + 20; // ширина + gap
      track.style.transform = `translateX(-${currentPage * cardsPerPage * cardWidth}px)`;
    }

    updateNavButtons();
    updateDots();
  }

  // Обновить состояние кнопок
  function updateNavButtons() {
    const prevBtn = container.querySelector('.evidpo-rec-prev');
    const nextBtn = container.querySelector('.evidpo-rec-next');
    const totalPages = Math.ceil(courses.length / cardsPerPage);

    if (prevBtn) prevBtn.disabled = currentPage === 0;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages - 1 || courses.length <= cardsPerPage;
  }

  // Обновить точки
  function updateDots() {
    const dots = container.querySelectorAll('.evidpo-rec-dot');
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === currentPage);
    });
  }

  // Определить количество карточек на странице
  function updateCardsPerPage() {
    const width = window.innerWidth;
    if (width <= 480) {
      cardsPerPage = 2;
    } else if (width <= 768) {
      cardsPerPage = 2;
    } else if (width <= 1024) {
      cardsPerPage = 3;
    } else {
      cardsPerPage = 4;
    }
  }

  // Обработка ресайза
  function handleResize() {
    const oldCardsPerPage = cardsPerPage;
    updateCardsPerPage();

    if (oldCardsPerPage !== cardsPerPage && courses.length > 0) {
      currentPage = 0;
      render();
      setupNavigation();
    }
  }

  // Debounce
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }
})();
</script>