<!-- Meilisearch Full-Screen Search Overlay for evidpo.ru v2 -->
<style>
/* Поле-триггер поиска - на всю ширину блока */
.evidpo-search-trigger {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 14px 20px;
  background: #fff;
  border: 2px solid #7c3aed;
  border-radius: 8px;
  cursor: text;
  font-size: 16px;
  color: #9ca3af;
  transition: all 0.2s;
  box-sizing: border-box;
}

.evidpo-search-trigger:hover {
  border-color: #6d28d9;
  box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
}

.evidpo-search-trigger svg {
  width: 20px;
  height: 20px;
  stroke: #7c3aed;
  flex-shrink: 0;
}

/* Оверлей */
.evidpo-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fff;
  z-index: 99999;
  display: none;
  flex-direction: column;
  overflow: hidden;
}

.evidpo-overlay.active {
  display: flex;
}

/* Шапка поиска */
.evidpo-overlay-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 24px;
  border-bottom: 1px solid #e2e8f0;
  background: #fff;
  flex-shrink: 0;
}

.evidpo-overlay-input-wrap {
  flex: 1;
  position: relative;
  min-width: 0;
}

.evidpo-overlay-input {
  width: 100%;
  padding: 14px 44px 14px 48px;
  font-size: 16px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  outline: none;
  transition: border-color 0.2s;
  background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E") no-repeat 16px center;
  box-sizing: border-box;
}

.evidpo-overlay-input:focus {
  border-color: #7c3aed;
}

.evidpo-overlay-input::placeholder {
  color: #9ca3af;
}

.evidpo-clear-btn {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px;
  height: 28px;
  border: none;
  background: #e2e8f0;
  border-radius: 50%;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #64748b;
  transition: background 0.15s;
}

.evidpo-clear-btn:hover {
  background: #cbd5e1;
}

.evidpo-clear-btn.visible {
  display: flex;
}

.evidpo-btn-find {
  padding: 14px 32px;
  background: #7c3aed;
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}

.evidpo-btn-find:hover {
  background: #6d28d9;
}

.evidpo-btn-close {
  padding: 14px 24px;
  background: none;
  border: none;
  font-size: 15px;
  color: #64748b;
  cursor: pointer;
  transition: color 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}

.evidpo-btn-close:hover {
  color: #1e293b;
}

/* Контент */
.evidpo-overlay-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  -webkit-overflow-scrolling: touch;
}

.evidpo-search-layout {
  display: flex;
  gap: 40px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Левая колонка */
.evidpo-search-sidebar {
  width: 200px;
  flex-shrink: 0;
}

.evidpo-sidebar-section {
  margin-bottom: 28px;
}

.evidpo-sidebar-title {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 12px;
}

.evidpo-sidebar-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.evidpo-sidebar-list li {
  margin-bottom: 8px;
}

.evidpo-sidebar-list a {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #475569;
  text-decoration: none;
  transition: color 0.15s;
}

.evidpo-sidebar-list a:hover {
  color: #7c3aed;
}

.evidpo-sidebar-list svg {
  width: 16px;
  height: 16px;
  stroke: #94a3b8;
  flex-shrink: 0;
}

/* Правая колонка - результаты */
.evidpo-search-main {
  flex: 1;
  min-width: 0;
}

.evidpo-results-title {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 20px;
}

.evidpo-results-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
}

/* Карточка курса - теперь ссылка */
.evidpo-course-card {
  display: block;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  overflow: hidden;
  text-decoration: none;
  transition: all 0.2s;
  cursor: pointer;
}

.evidpo-course-card:hover {
  border-color: #7c3aed;
  box-shadow: 0 8px 30px rgba(124, 58, 237, 0.12);
  transform: translateY(-2px);
}

.evidpo-course-image {
  width: 100%;
  height: 160px;
  background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.evidpo-course-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.evidpo-course-placeholder {
  width: 80px;
  height: 100px;
  background: #fff;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}

.evidpo-course-placeholder svg {
  width: 40px;
  height: 40px;
  stroke: #7c3aed;
}

.evidpo-course-info {
  padding: 16px;
}

.evidpo-course-title {
  font-size: 14px;
  font-weight: 500;
  color: #1e293b;
  line-height: 1.4;
  margin-bottom: 8px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.evidpo-course-price {
  font-size: 18px;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 12px;
}

.evidpo-course-btn {
  display: inline-block;
  padding: 10px 24px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  color: #475569;
  background: #fff;
  text-decoration: none;
  transition: all 0.15s;
  text-align: center;
}

.evidpo-course-card:hover .evidpo-course-btn {
  border-color: #7c3aed;
  color: #7c3aed;
}

/* Кнопка показать ещё */
.evidpo-all-results {
  text-align: center;
  margin-top: 32px;
}

.evidpo-load-more-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 14px 28px;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
  color: #475569;
  background: #fff;
  cursor: pointer;
  transition: all 0.15s;
}

.evidpo-load-more-btn:hover {
  border-color: #7c3aed;
  color: #7c3aed;
}

.evidpo-load-more-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Пустое состояние */
.evidpo-empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #64748b;
}

.evidpo-empty-state svg {
  width: 64px;
  height: 64px;
  stroke: #cbd5e1;
  margin-bottom: 16px;
}

.evidpo-empty-state p {
  font-size: 16px;
  margin: 0;
}

/* Загрузка */
.evidpo-loading {
  text-align: center;
  padding: 60px 20px;
  color: #64748b;
}

mark {
  background: #fef08a;
  color: inherit;
  padding: 0 2px;
  border-radius: 2px;
}

/* ========== АДАПТИВНОСТЬ ========== */

/* Большие экраны (1400px+) */
@media (min-width: 1400px) {
  .evidpo-results-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

/* Средние экраны (1024px - 1200px) */
@media (max-width: 1200px) {
  .evidpo-search-layout {
    gap: 30px;
  }
  
  .evidpo-search-sidebar {
    width: 180px;
  }
  
  .evidpo-results-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }
}

/* Планшеты и мобильные (до 1024px) */
@media (max-width: 1024px) {
  .evidpo-overlay-header {
    flex-wrap: wrap;
    padding: 12px 16px;
    gap: 10px;
  }
  
  .evidpo-overlay-input-wrap {
    order: 1;
    width: 100%;
    flex: none;
  }
  
  .evidpo-overlay-input {
    padding: 12px 40px 12px 44px;
    font-size: 16px;
  }
  
  .evidpo-btn-find {
    order: 2;
    flex: 1;
    padding: 12px 20px;
  }
  
  .evidpo-btn-close {
    order: 3;
    padding: 12px 16px;
  }
  
  .evidpo-overlay-content {
    padding: 16px;
  }
  
  .evidpo-search-layout {
    flex-direction: column;
    gap: 20px;
  }
  
  .evidpo-search-sidebar {
    width: 100%;
    display: flex;
    gap: 24px;
    overflow-x: auto;
    padding-bottom: 8px;
    -webkit-overflow-scrolling: touch;
  }
  
  .evidpo-sidebar-section {
    flex-shrink: 0;
    margin-bottom: 0;
    min-width: 140px;
  }
  
  /* Показываем только 4 категории */
  #evidpoCategories li:nth-child(n+5) {
    display: none;
  }
  
  .evidpo-results-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .evidpo-course-image {
    height: 120px;
  }
  
  .evidpo-course-info {
    padding: 12px;
  }
  
  .evidpo-course-title {
    font-size: 13px;
  }
  
  .evidpo-course-price {
    font-size: 16px;
  }
  
  .evidpo-course-btn {
    padding: 8px 16px;
    font-size: 13px;
  }
}

/* Мобильные (до 768px) */
@media (max-width: 768px) {
  .evidpo-sidebar-section {
    min-width: 120px;
  }
}

/* Маленькие мобильные (до 480px) */
@media (max-width: 480px) {
  .evidpo-overlay-header {
    padding: 10px 12px;
  }
  
  .evidpo-overlay-input {
    padding: 10px 36px 10px 40px;
    font-size: 15px;
    background-position: 12px center;
    background-size: 18px 18px;
  }
  
  .evidpo-clear-btn {
    width: 24px;
    height: 24px;
    right: 8px;
    font-size: 12px;
  }
  
  .evidpo-btn-find {
    padding: 10px 16px;
    font-size: 14px;
  }
  
  .evidpo-btn-close {
    padding: 10px 12px;
    font-size: 14px;
  }
  
  .evidpo-overlay-content {
    padding: 12px;
  }
  
  .evidpo-search-sidebar {
    gap: 16px;
  }
  
  .evidpo-sidebar-section {
    min-width: 120px;
  }
  
  .evidpo-sidebar-title {
    font-size: 13px;
    margin-bottom: 8px;
  }
  
  .evidpo-sidebar-list a {
    font-size: 13px;
  }
  
  .evidpo-results-title {
    font-size: 13px;
    margin-bottom: 12px;
  }
  
  .evidpo-results-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .evidpo-course-image {
    height: 100px;
  }
  
  .evidpo-course-info {
    padding: 10px;
  }
  
  .evidpo-course-title {
    font-size: 12px;
    -webkit-line-clamp: 2;
    margin-bottom: 6px;
  }
  
  .evidpo-course-price {
    font-size: 14px;
  }
  
  .evidpo-course-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .evidpo-all-results a {
    padding: 12px 20px;
    font-size: 13px;
  }
}

/* Очень маленькие экраны (до 360px) */
@media (max-width: 360px) {
  .evidpo-results-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .evidpo-course-card {
    display: flex;
    flex-direction: row;
  }
  
  .evidpo-course-image {
    width: 100px;
    height: auto;
    min-height: 100px;
    flex-shrink: 0;
  }
  
  .evidpo-course-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  
  .evidpo-course-btn {
    display: none;
  }
}
</style>

<!-- Кнопка поиска для шапки -->
<button class="evidpo-search-trigger" id="evidpoSearchTrigger">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
  <span>Искать курсы</span>
</button>

<!-- Оверлей поиска -->
<div class="evidpo-overlay" id="evidpoOverlay">
  <div class="evidpo-overlay-header">
    <div class="evidpo-overlay-input-wrap">
      <input type="text" class="evidpo-overlay-input" id="evidpoInput" placeholder="Искать курсы..." autocomplete="off">
      <button class="evidpo-clear-btn" id="evidpoClear">✕</button>
    </div>
    <button class="evidpo-btn-find" id="evidpoBtnFind">Найти</button>
    <button class="evidpo-btn-close" id="evidpoClose">Закрыть</button>
  </div>
  
  <div class="evidpo-overlay-content">
    <div class="evidpo-search-layout">
      <!-- Сайдбар -->
      <div class="evidpo-search-sidebar">
        <div class="evidpo-sidebar-section">
          <div class="evidpo-sidebar-title">Часто ищут</div>
          <ul class="evidpo-sidebar-list" id="evidpoPopularQueries">
            <!-- Загружаются динамически -->
          </ul>
        </div>
        
        <div class="evidpo-sidebar-section">
          <div class="evidpo-sidebar-title">Категории</div>
          <ul class="evidpo-sidebar-list" id="evidpoCategories">
            <!-- Загружаются динамически -->
          </ul>
        </div>
      </div>
      
      <!-- Результаты -->
      <div class="evidpo-search-main">
        <div class="evidpo-results-title" id="evidpoResultsTitle">Популярные курсы</div>
        <div class="evidpo-results-grid" id="evidpoResults"></div>
        <div class="evidpo-all-results" id="evidpoAllResults" style="display: none;">
          <button type="button" id="evidpoLoadMore" class="evidpo-load-more-btn">
            Показать ещё
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const MEILI_HOST = 'https://getmeilimeilisearchv190-production-6123b.up.railway.app';
  const MEILI_KEY = 'b17c51453595ca37ff81b5c5b7ae8b7d0541d6b3e375fecd86831572dee58660';
  const INDEX = 'courses';
  const ITEMS_PER_PAGE = 6;
  
  // Маппинг направлений в поисковые запросы
  const directionToQuery = {
    'Первая помощь': 'первая помощь',
    'Пожарная безопасность': 'пожарная безопасность',
    'Автошколы': 'автошкола',
    'Педагогика': 'педагогика',
    'Научная работа': 'научная работа',
    'Охрана труда': 'охрана труда',
    'Рабочие профессии': 'рабочие профессии',
    'БДД': 'безопасность дорожного движения',
    'Экологическая безопасность': 'экология',
    'Психология': 'психология',
    'Кадровое дело': 'кадровое дело',
    'Медицина': 'медицина',
    'Закупки': 'закупки 44-ФЗ',
    'Строительство': 'строительство',
    'Энергетика': 'энергетика',
    'Промышленная безопасность': 'промышленная безопасность',
    'Бухгалтерский учёт': 'бухгалтерия',
    'Делопроизводство': 'делопроизводство',
    'Менеджмент': 'менеджмент',
    'Юриспруденция': 'юриспруденция'
  };
  
  // Элементы
  const trigger = document.getElementById('evidpoSearchTrigger');
  const overlay = document.getElementById('evidpoOverlay');
  const input = document.getElementById('evidpoInput');
  const clearBtn = document.getElementById('evidpoClear');
  const closeBtn = document.getElementById('evidpoClose');
  const findBtn = document.getElementById('evidpoBtnFind');
  const resultsGrid = document.getElementById('evidpoResults');
  const resultsTitle = document.getElementById('evidpoResultsTitle');
  const allResultsWrap = document.getElementById('evidpoAllResults');
  const loadMoreBtn = document.getElementById('evidpoLoadMore');
  const categoriesList = document.getElementById('evidpoCategories');
  const popularQueriesList = document.getElementById('evidpoPopularQueries');
  
  let debounceTimer;
  let currentQuery = '';
  let currentOffset = 0;
  let totalHits = 0;
  let isLoading = false;
  let categoriesLoaded = false;
  
  // Скрыть/показать виджет рекомендаций (решает проблему z-index в Creatium)
  const recWidget = document.getElementById('evidpo-recommendations');

  // Открыть оверлей
  trigger.addEventListener('click', () => {
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    if (recWidget) recWidget.style.display = 'none';
    input.focus();
    if (!categoriesLoaded) {
      loadCategories();
    }
    if (!input.value) {
      loadPopularCourses();
    }
  });

  // Закрыть оверлей
  closeBtn.addEventListener('click', closeOverlay);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.classList.contains('active')) {
      closeOverlay();
    }
  });

  function closeOverlay() {
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    if (recWidget) recWidget.style.display = '';
  }
  
  // Очистить поиск
  clearBtn.addEventListener('click', () => {
    input.value = '';
    clearBtn.classList.remove('visible');
    currentQuery = '';
    currentOffset = 0;
    loadPopularCourses();
    input.focus();
  });
  
  // Ввод текста
  input.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    
    clearBtn.classList.toggle('visible', query.length > 0);
    
    if (query.length < 2) {
      if (query.length === 0) {
        currentQuery = '';
        currentOffset = 0;
        loadPopularCourses();
      }
      return;
    }
    
    debounceTimer = setTimeout(() => {
      currentOffset = 0;
      search(query, false);
    }, 250);
  });
  
  // Кнопка найти - выполнить поиск
  findBtn.addEventListener('click', () => {
    const query = input.value.trim();
    if (query) {
      currentOffset = 0;
      search(query, false);
    }
  });
  
  // Enter для поиска
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const query = input.value.trim();
      if (query) {
        currentOffset = 0;
        search(query, false);
      }
    }
  });
  
  // Кнопка "Показать ещё"
  loadMoreBtn.addEventListener('click', () => {
    if (!isLoading && currentQuery) {
      search(currentQuery, true);
    }
  });
  
  // Загрузить популярные курсы
  async function loadPopularCourses() {
    resultsTitle.textContent = 'Популярные курсы';
    allResultsWrap.style.display = 'none';
    currentOffset = 0;
    
    try {
      const response = await fetch(`${MEILI_HOST}/indexes/${INDEX}/search`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${MEILI_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          q: '',
          limit: ITEMS_PER_PAGE,
          sort: ['students:desc']
        })
      });
      
      const data = await response.json();
      renderResults(data.hits || [], false);
    } catch (error) {
      console.error('Load popular error:', error);
    }
  }
  
  // Загрузить категории и часто ищут (по сумме студентов)
  async function loadCategories() {
    try {
      // Запрашиваем курсы для подсчёта студентов по направлениям
      const response = await fetch(`${MEILI_HOST}/indexes/${INDEX}/search`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${MEILI_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          q: '',
          limit: 1000,
          attributesToRetrieve: ['direction', 'students']
        })
      });
      
      const data = await response.json();
      const hits = data.hits || [];
      
      // Агрегируем студентов по направлениям
      const directionStats = {};
      hits.forEach(hit => {
        const dir = hit.direction;
        if (dir) {
          if (!directionStats[dir]) {
            directionStats[dir] = { count: 0, students: 0 };
          }
          directionStats[dir].count++;
          directionStats[dir].students += (hit.students || 0);
        }
      });
      
      // Сортируем по количеству студентов (по убыванию)
      const sorted = Object.entries(directionStats)
        .sort((a, b) => b[1].students - a[1].students);
      
      // === Часто ищут (топ-4) ===
      const searchIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>';
      const top4 = sorted.slice(0, 4);
      
      popularQueriesList.innerHTML = top4.map(([dirName]) => {
        const queryText = directionToQuery[dirName] || dirName.toLowerCase();
        return `<li><a href="#" data-query="${queryText}">${searchIcon}${queryText}</a></li>`;
      }).join('');
      
      // Обработчики для "Часто ищут"
      popularQueriesList.querySelectorAll('[data-query]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const query = link.dataset.query;
          input.value = query;
          clearBtn.classList.add('visible');
          currentOffset = 0;
          search(query, false);
        });
      });
      
      // === Категории (топ-10) ===
      const categoryIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>';
      const top10 = sorted.slice(0, 10);
      
      categoriesList.innerHTML = top10.map(([name]) => 
        `<li><a href="#" data-category="${name}">${categoryIcon}${name}</a></li>`
      ).join('');
      
      // Обработчики для категорий
      categoriesList.querySelectorAll('[data-category]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const category = link.dataset.category;
          input.value = category;
          clearBtn.classList.add('visible');
          currentOffset = 0;
          search(category, false);
        });
      });
      
      categoriesLoaded = true;
    } catch (error) {
      console.error('Load categories error:', error);
    }
  }
  
  // Поиск
  async function search(query, append = false) {
    if (isLoading) return;
    
    currentQuery = query;
    isLoading = true;
    resultsTitle.textContent = 'Результаты поиска';
    
    if (!append) {
      currentOffset = 0;
      resultsGrid.innerHTML = '<div class="evidpo-loading">Поиск...</div>';
    } else {
      loadMoreBtn.disabled = true;
      loadMoreBtn.innerHTML = 'Загрузка... <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>';
    }
    
    try {
      const response = await fetch(`${MEILI_HOST}/indexes/${INDEX}/search`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${MEILI_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          q: query,
          limit: ITEMS_PER_PAGE,
          offset: currentOffset,
          attributesToHighlight: ['title'],
          highlightPreTag: '<mark>',
          highlightPostTag: '</mark>'
        })
      });
      
      const data = await response.json();
      totalHits = data.estimatedTotalHits || 0;
      
      if (data.hits && data.hits.length > 0) {
        renderResults(data.hits, append);
        currentOffset += data.hits.length;
        
        // Показать кнопку если есть ещё результаты
        if (currentOffset < totalHits) {
          allResultsWrap.style.display = 'block';
          const remaining = totalHits - currentOffset;
          loadMoreBtn.innerHTML = `Показать ещё (${remaining}) <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>`;
          loadMoreBtn.disabled = false;
        } else {
          allResultsWrap.style.display = 'none';
        }
      } else if (!append) {
        resultsGrid.innerHTML = `
          <div class="evidpo-empty-state" style="grid-column: 1 / -1;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <p>По запросу «${query}» ничего не найдено</p>
          </div>
        `;
        allResultsWrap.style.display = 'none';
      }
    } catch (error) {
      console.error('Search error:', error);
      if (!append) {
        resultsGrid.innerHTML = '<div class="evidpo-empty-state" style="grid-column: 1 / -1;"><p>Ошибка поиска</p></div>';
      }
    } finally {
      isLoading = false;
      loadMoreBtn.disabled = false;
    }
  }
  
  // Рендер результатов - карточки как ссылки, открываются в новой вкладке
  function renderResults(hits, append = false) {
    if (!hits.length && !append) {
      resultsGrid.innerHTML = '<div class="evidpo-empty-state" style="grid-column: 1 / -1;"><p>Нет курсов</p></div>';
      return;
    }
    
    const cardsHtml = hits.map(hit => {
      const title = hit._formatted?.title || hit.title;
      const price = hit.price ? `${hit.price.toLocaleString('ru-RU')} ₽` : '';
      const imageUrl = hit.image || '';
      
      return `
        <a href="${hit.url}" target="_blank" rel="noopener" class="evidpo-course-card" data-course-id="${hit.id}" data-course-title="${hit.title}">
          <div class="evidpo-course-image">
            ${imageUrl 
              ? `<img src="${imageUrl}" alt="" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'evidpo-course-placeholder\\'><svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'1.5\\'><path d=\\'M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20\\'/></svg></div>'">`
              : `<div class="evidpo-course-placeholder">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                  </svg>
                </div>`
            }
          </div>
          <div class="evidpo-course-info">
            <div class="evidpo-course-title">${title}</div>
            ${price ? `<div class="evidpo-course-price">${price}</div>` : ''}
            <span class="evidpo-course-btn">Подробнее</span>
          </div>
        </a>
      `;
    }).join('');
    
    if (append) {
      resultsGrid.insertAdjacentHTML('beforeend', cardsHtml);
    } else {
      resultsGrid.innerHTML = cardsHtml;
    }
  }
  
})();
</script>
